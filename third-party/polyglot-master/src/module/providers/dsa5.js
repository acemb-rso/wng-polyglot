import LanguageProvider from "./templates/Base.js";

export default class dsa5LanguageProvider extends LanguageProvider {
	defaultFont = "Ophidian";

	languages = {
		garethi: {
			label: "Garethi",
			font: "Miroslav Normal",
			rng: "default",
		},
		alaani: {
			label: "Alaani",
			font: "Miroslav Normal",
			rng: "default",
		},
		"altes alaani": {
			label: "Altes Alaani",
			font: "Highschool Runes",
			rng: "default",
		},
		amulashtra: {
			label: "Amulashtra",
			font: "Qijomi",
			rng: "default",
		},
		angram: {
			label: "Angram",
			font: "Skaven",
			rng: "default",
		},
		"angram-bilderschrift": {
			label: "Angram-Bilderschrift",
			font: "Skaven",
			rng: "default",
		},
		arkanil: {
			label: "Arkanil",
			font: "Ar Ciela",
			rng: "default",
		},
		asdharia: {
			label: "Asdharia",
			font: "Tengwar",
			rng: "default",
		},
		atak: {
			label: "Atak",
			font: "FingerAlphabet",
			rng: "default",
		},
		aureliani: {
			label: "Aureliani",
			font: "Infernal",
			rng: "default",
		},
		bosparano: {
			label: "Bosparano",
			font: "Miroslav Normal",
			rng: "default",
		},
		chrmk: {
			label: "Chrmk",
			font: "Iokharic",
			rng: "default",
		},
		chuchas: {
			label: "Chuchas",
			font: "Kargi",
			rng: "default",
		},
		"drakhard-zinken": {
			label: "Drakhard-Zinken",
			font: "Celestial",
			rng: "default",
		},
		fjarningsch: {
			label: "Fjarningsch",
			font: "Dethek",
			rng: "default",
		},
		"geheiligte glyphen von unau": {
			label: "Geheiligte Glyphen von Unau",
			font: "High Drowic",
			rng: "default",
		},
		"gimaril-glyphen": {
			label: "Gimaril-Glyphen",
			font: "Semphari",
			rng: "default",
		},
		goblinisch: {
			label: "Goblinisch",
			font: "Ork Glyphs",
			rng: "default",
		},
		"hjaldingsche hunen": {
			font: "Olde Thorass",
			rng: "default",
		},
		"imperiale zeichen": {
			label: "Imperiale Zeichen",
			font: "Infernal",
			rng: "default",
		},
		isdira: {
			label: "Isdira",
			font: "Tengwar",
			rng: "default",
		},
		"isdira- und asdharia-zeichen": {
			label: "Isdira- und Asdharia-Zeichen",
			font: "Tengwar",
			rng: "default",
		},
		"kusliker zeichen": {
			label: "Kusliker Zeichen",
			font: "Miroslav Normal",
			rng: "default",
		},
		mohisch: {
			label: "Mohisch",
			font: "Jungle Slang",
			rng: "default",
		},
		"nanduria-zeichen": {
			label: "Nanduria-Zeichen",
			font: "Espruar",
			rng: "default",
		},
		nujuka: {
			label: "Nujuka",
			font: "Reanaarian",
			rng: "default",
		},
		ogrisch: {
			label: "Ogrisch",
			font: "Ork Glyphs",
			rng: "default",
		},
		oloarkh: {
			label: "Oloarkh",
			font: "Ork Glyphs",
			rng: "default",
		},
		ologhaijan: {
			label: "Ologhaijan",
			font: "Ork Glyphs",
			rng: "default",
		},
		protozelemja: {
			label: "Protozelemja",
			font: "Kargi",
			rng: "default",
		},
		rabensprache: {
			label: "Rabensprache",
			font: "Valmaric",
			rng: "default",
		},
		rogolan: {
			label: "Rogolan",
			font: "Elder Futhark",
			rng: "default",
		},
		"rogolan-runen": {
			label: "Rogolan-Runen",
			font: "Elder Futhark",
			rng: "default",
		},
		rssahh: {
			label: "Rssahh",
			font: "Iokharic",
			rng: "default",
		},
		ruuz: {
			label: "Ruuz",
			font: "Valmaric",
			rng: "default",
		},
		"saga-thorwalsch": {
			label: "Saga-Thorwalsch",
			font: "Olde Thorass",
			rng: "default",
		},
		tahaya: {
			label: "Tahaya",
			font: "Jungle Slang",
			rng: "default",
		},
		thorwalsch: {
			label: "Thorwalsch",
			font: "Floki",
			rng: "default",
		},
		"thorwalsche runen": {
			label: "Thorwalsche Runen",
			font: "Floki",
			rng: "default",
		},
		trollisch: {
			label: "Trollisch",
			font: "Eltharin",
			rng: "default",
		},
		"trollische raumbildschrift": {
			label: "Trollische Raumbildschrift",
			font: "Eltharin",
			rng: "default",
		},
		tulamidya: {
			label: "Tulamidya",
			font: "Valmaric",
			rng: "default",
		},
		"tulamidya-zeichen": {
			label: "Tulamidya-Zeichen",
			font: "Valmaric",
			rng: "default",
		},
		"ur-tulamidya": {
			label: "Ur-Tulamidya",
			font: "Olde Espruar",
			rng: "default",
		},
		"ur-tulamidya-zeichen": {
			label: "Ur-Tulamidya-Zeichen",
			font: "Olde Espruar",
			rng: "default",
		},
		"yash-hualay-glyphen": {
			label: "Yash-Hualay-Glyphen",
			font: "Kargi",
			rng: "default",
		},
		zelemja: {
			label: "Zelemja",
			font: "Iokharic",
			rng: "default",
		},
		zhayad: {
			label: "Zhayad",
			font: "Pulsian",
			rng: "default",
		},
		"zhayad-zeichen": {
			label: "Zhayad-Zeichen",
			font: "Pulsian",
			rng: "default",
		},
		zyklopäisch: {
			label: "Zyklopäisch",
			font: "Miroslav Normal",
			rng: "default",
		},
	};

	requiresReady = true;

	getSystemDefaultLanguage() {
		return "garethi";
	}

	async getLanguages() {
		if (this.replaceLanguages) {
			this.languages = {};
			return;
		}
		if (game.modules.has("dsa5-core") && game.modules.get("dsa5-core").active) {
			// use old compendium for versions < 11, remove this if module's version doesn't support those foundry versions anymore
			const packName = Number(game.version.split(".")[0]) < 11 ? "abilities" : "equipment";
			const dsa5Pack = game.packs.get(`dsa5-core.core${packName}`) ?? game.packs.get(`dsa5-core.coreen${packName}`);
			const languages = {};
			if (dsa5Pack) {
				const dsa5ItemList = await dsa5Pack.getIndex();
				const languageRegex = new RegExp(`${game.i18n.localize("LocalizedIDs.language")}\\s*\\((.+)\\)`, "i");
				const literacyRegex = new RegExp(`${game.i18n.localize("LocalizedIDs.literacy")}\\s*\\((.+)\\)`, "i");
				const languagesSetting = game.settings.get("polyglot", "Languages");

				const setLanguageInfo = (item, regex) => {
					const match = item.name.match(regex);
					if (match) {
						const label = match[1].trim();
						const key = label.toLowerCase();
						languages[key] = {
							label,
							font: languagesSetting[key]?.font || this.languages[key]?.font || this.defaultFont,
							rng: languagesSetting[key]?.rng ?? "default",
						};
					}
				};

				for (const item of dsa5ItemList) {
					if (languageRegex.test(item.name)) setLanguageInfo(item, languageRegex);
					else if (literacyRegex.test(item.name)) setLanguageInfo(item, literacyRegex);
				}
				this.languages = languages;
			} else {
				ui.notifications.error(
					`Polyglot | The ${game.modules.get("dsa5-core").title} pack wasn't retrieved correctly. Defaulting to built-in languages.`,
					{
						console: false,
					}
				);
			}
		}
	}

	getUserLanguages(actor) {
		let knownLanguages = new Set();
		let literateLanguages = new Set();
		let languageRegex = new RegExp(`${game.i18n.localize("LocalizedIDs.language")}\\s*\\((.+)\\)`, "i");
		let literacyRegex = new RegExp(`${game.i18n.localize("LocalizedIDs.literacy")}\\s*\\((.+)\\)`, "i");
		for (let item of actor.items) {
			if (item.system.category?.value === "language") {
				if (languageRegex.test(item.name)) {
					knownLanguages.add(item.name.match(languageRegex)[1].trim().toLowerCase());
				} else if (literacyRegex.test(item.name)) {
					literateLanguages.add(item.name.match(literacyRegex)[1].trim().toLowerCase());
				}
			}
		}
		return [knownLanguages, literateLanguages];
	}

	conditions(lang) {
		return game.polyglot.literateLanguages.has(lang);
	}
}
